{{- if .Values.homepage.enabled }}
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ .Values.argocd.project }}-homepage
  namespace: {{ .Values.argocd.namespace }}
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: {{ .Values.argocd.project }}
  syncPolicy:
    automated:
      selfHeal: true
      prune: true
    syncOptions:
      - CreateNamespace=true
  destination:
    name: in-cluster
    namespace: apps
  source:
    repoURL: http://jameswynn.github.io/helm-charts 
    chart: home
    targetRevision: 1.2.3
    helm:
      releaseName: homepage
      values: |
        image:
          repository: ghcr.io/gethomepage/homepage
          tag: v0.8.4
        enableRbac: true 
        serviceAccount:
          name: homepage
          create: true
        ingress:
          main:
            enabled: true
            annotations:
              cert-manager.io/cluster-issuer: "letsencrypt-prod"
              external-dns.alpha.kubernetes.io/target: "{{ .Values.global.env }}-humble-tunnel.{{ .Values.global.domain }}"
              external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
            ingressClassName: "nginx"
            hosts:
              - host: &host "home.{{ .Values.global.domain }}"
                paths:
                  - path: /
                    pathType: Prefix
            tls:
              - hosts:
                - *host
        config:
          kubernetes:
            mode: cluster
          settings:
            background: https://imagedelivery.net/34xh1sPWPAwO1lv63pW2Eg/992fd3c9-33f9-461e-6894-7210ef7a1500/public
            cardBlur: md
            theme: dark
            headerStyle: boxed
            hideVersion: true
          widgets:
            - search:
                provider: google
                target: _blank
          services:
            - Entertainment (in-progress):
              - Matrix:
                  href: https://chat.{{ .Values.global.domain }}
                  description: Chat client
                  icon: element.svg
              - Jellyfin:
                  href: https://jellyfin.{{ .Values.global.domain }}
                  description: Media system (movies, music, etc.)
                  icon: jellyfin.svg
              - Jellyseerr:
                  href: https://jellyseerr.{{ .Values.global.domain }}
                  description: Request media
                  icon: jellyseerr.svg
            - Management:
              - Kanidm:
                  href: https://authv2.{{ .Values.global.domain }}
                  description: Identity management
                  icon: https://authv2.{{ .Values.global.domain }}/pkg/img/logo-square.svg
            - Development:
              - ArgoCD:
                  href: https://argocd.{{ .Values.global.domain }}
                  description: Continuous deployment
                  icon: argocd.svg
              - Grafana:
                  href: https://grafana.{{ .Values.global.domain }}
                  description: Observability dashboards
                  icon: grafana.svg
            - Utilities:
              - Excalidraw:
                  href: https://draw.{{ .Values.global.domain }}
                  description: Virtual whiteboard
                  icon: excalidraw.svg
              - Speedtest:
                  href: https://speedtest.{{ .Values.global.domain }}
                  description: Internal network speed test
                  icon: openspeedtest.png
          bookmarks:
            - Homelab:
              - Documentation:
                - href: https://humble.{{ .Values.global.domain }}
                  icon: google-docs.svg
              - Public repository:
                - href: https://github.com/locmai/humble
                  icon: github.svg
            - Managed services:
              - Cloudflare:
                - href: https://dash.cloudflare.com
                  icon: cloudflare.svg
{{- end }}
